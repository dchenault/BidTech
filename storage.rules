
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // A user can read/write to an account's items folder if they are a member of that account.
    // This rule is critical for multi-tenancy, ensuring users from one account
    // cannot access the images of another account.
    match /items/{accountId}/{allPaths=**} {
      function isAccountMember(accountId) {
        // Security rules cannot call functions from other rule files.
        // We must redefine the logic here. It checks if a user is logged in
        // and if their user profile document contains a reference to the accountId.
        let userProfile = get(/databases/$(database)/documents/users/$(request.auth.uid));
        return request.auth != null &&
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               userProfile.data.accounts[accountId] != null;
      }
      allow read, write: if isAccountMember(accountId);
    }
  }
}
