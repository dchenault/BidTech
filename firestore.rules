
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // By default, deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    function isOwner(accountId) {
      return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)).data.adminUserId == request.auth.uid;
    }

    function isAccountMember(accountId) {
      return request.auth != null && exists(/databases/$(database)/documents/accounts/$(accountId)/users/$(request.auth.uid));
    }

    function isSignedIn() {
      return request.auth != null;
    }

    match /accounts/{accountId} {
      allow get: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.adminUserId == request.auth.uid;
      allow update: if isOwner(accountId);
      allow list, delete: if false;

      match /users/{userId} {
        // Allow a user to read their own profile, or any member to read any profile.
        allow get: if isAccountMember(accountId) || (isSignedIn() && request.auth.uid == userId);
        // Only members can list all users.
        allow list: if isAccountMember(accountId);
        
        // A new user can create THEIR OWN user document.
        allow create: if isSignedIn() && request.auth.uid == userId;

        // An admin can update or delete any user.
        allow update, delete: if isOwner(accountId);
      }

      match /patrons/{patronId} {
        allow read, write: if isAccountMember(accountId);
      }

      match /invitations/{inviteId} {
        allow read: if isAccountMember(accountId) || request.auth.token.email == resource.data.email;
        allow create, delete: if isOwner(accountId);
        allow update: if isOwner(accountId) || (isSignedIn() && request.auth.token.email == resource.data.email);
      }

      match /auctions/{auctionId} {
        function isAuctionManager() {
          return request.auth != null && resource.data.managers[request.auth.uid] != null;
        }

        allow read: if isAccountMember(accountId);
        allow create: if isSignedIn() && (request.resource.data.adminUserId == request.auth.uid || isAccountMember(accountId)) && request.resource.data.accountId == accountId;
        
        // Allow update if user is owner, existing manager, OR if they are an account member adding ONLY themselves to managers.
        allow update: if isOwner(accountId) || isAuctionManager() || 
                      (isAccountMember(accountId) && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['managers']) && 
                       request.resource.data.managers.diff(resource.data.managers).addedKeys().hasOnly([request.auth.uid]));

        allow delete: if isOwner(accountId);

        match /items/{itemId} {
          allow read, write: if isAccountMember(accountId);
        }

        match /lots/{lotId} {
          allow read, write: if isAccountMember(accountId);
        }

        match /categories/{categoryId} {
          allow read, write: if isAccountMember(accountId);
        }

        match /registered_patrons/{regPatronId} {
          allow read, write: if isAccountMember(accountId);
        }
      }
    }
  }
}
