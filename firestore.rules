
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // By default, deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // ========= HELPER FUNCTIONS =========
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAccountAdmin(accountId) {
      // Use the user's profile document to check for admin role.
      let userProfile = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return isSignedIn() && userProfile.data.accounts[accountId] == 'admin';
    }

    function isAccountMember(accountId) {
      // Use the user's profile document to check for any role in the account.
      let userProfile = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return isSignedIn() && userProfile.data.accounts[accountId] != null;
    }

    // ========= ROOT COLLECTIONS =========
    
    // The `users` collection stores a profile for every authenticated user.
    match /users/{userId} {
      // A user can create their own profile. This is key for the signup flow.
      allow create: if isUser(userId);
      
      // A user can read or update their own profile.
      allow read, update: if isUser(userId);
      
      // No one can list all users or delete profiles from the client.
      allow list, delete: if false;
    }
    
    // The `invitations` collection stores invites for users to manage auctions.
    match /invitations/{inviteId} {
      // An admin of the target account can create or delete invites.
      allow create, delete: if isAccountAdmin(request.resource.data.accountId);
      
      // An admin can read all invites in their account. The invited user can read their own.
      allow read: if isAccountAdmin(resource.data.accountId) || 
                   (isSignedIn() && request.auth.token.email == resource.data.email);
                   
      // The invited user can update their own invite to accept it.
      allow update: if isSignedIn() && request.auth.token.email == resource.data.email;
    }
    
    // `accounts` holds all tenant data. Access is controlled by the user's profile.
    match /accounts/{accountId} {
      // A user can create their own account document. This happens in the same
      // batch as user profile creation, so we check the incoming request data.
      allow create: if isUser(request.resource.data.adminUserId) && request.resource.data.id == accountId;

      // Only a member of the account can read the account document.
      allow read: if isAccountMember(accountId);
      
      // Only the admin of the account can update or delete it.
      allow update, delete: if isAccountAdmin(accountId);

      // Disallow listing all accounts for security.
      allow list: if false;

      // --- Subcollections of an Account ---
      
      // All direct subcollections are accessible by any member of the account.
      // This provides a secure default for patrons, etc.
      match /patrons/{patronId} {
          allow read, write: if isAccountMember(accountId);
      }
      
      // Auctions have more granular rules for managers.
      match /auctions/{auctionId} {
        
        function isAuctionManager() {
          // Check the currently stored data, not the incoming request data.
          return get(/databases/$(database)/documents/accounts/$(accountId)/auctions/$(auctionId)).data.managers[request.auth.uid] == true;
        }

        // Any account member can read or create an auction.
        allow read, create: if isAccountMember(accountId);
        
        // Only admins or auction managers can delete an auction.
        allow delete: if isAccountAdmin(accountId) || isAuctionManager();

        // Update logic is the most complex.
        allow update: if 
          // An account admin can always update.
          isAccountAdmin(accountId) ||
          // An existing auction manager can update.
          isAuctionManager() ||
          // A new user accepting a valid invite can add themselves to the managers list.
          (
            isAccountMember(accountId) &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['managers']) &&
            request.resource.data.managers.size() == resource.data.managers.size() + 1 &&
            request.resource.data.managers[request.auth.uid] == true
          );

        // Rules for auction subcollections inherit from the auction's permissions.
        match /{subcollection}/{docId} {
            // Only account admins or auction managers can read/write items, lots, etc.
            allow read, write: if isAccountAdmin(accountId) || isAuctionManager();
        }
      }
    }
  }
}
