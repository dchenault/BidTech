
/**
 * @fileoverview Firestore Security Rules for the Auction App.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant security model where data is partitioned by Account.
 * Each Account has Users, Auctions, Patrons, Items, and Categories.  Authorization is primarily
 * based on the user's association with an Account and their role within an Auction (e.g., manager).
 *
 * Data Structure:
 * The data is structured hierarchically under `/accounts/{accountId}`.
 * - `/accounts/{accountId}`: Account information.
 * - `/accounts/{accountId}/users/{userId}`: User information for the account.
 * - `/accounts/{accountId}/patrons/{patronId}`: Patron information for the account.
 * - `/accounts/{accountId}/auctions/{auctionId}`: Auction information for the account, including a `managers` map for role-based access control.
 * - `/accounts/{accountId}/auctions/{auctionId}/items/{itemId}`: Item information for the auction.
 * - `/accounts/{accountId}/auctions/{auctionId}/lots/{lotId}`: Lot information for the auction.
 * - `/accounts/{accountId}/auctions/{auctionId}/categories/{categoryId}`: Category information for the auction.
 * - `/accounts/{accountId}/auctions/{auctionId}/registered_patrons/{registeredPatronId}`: Registered patron information for the auction.
 * - `/accounts/{accountId}/invitations/{invitationId}`: Invitations for users to manage auctions.
 *
 * Key Security Decisions:
 * - Users cannot list all accounts. Accounts can only be accessed by their administrators.
 * - All subcollections under `/accounts/{accountId}` are secured based on the user's association with that account.
 * - Auctions have a `managers` map for fine-grained access control (e.g., item managers).
 * - The rules do NOT implement field-level validation during this prototyping phase.
 *
 * Denormalization for Authorization:
 * - The `accountId` is present in every entity to avoid `get()` calls to parent documents.
 * - The `Auction` entity contains a `managers` map to denormalize user roles within the auction.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows administrators to manage accounts.
     * @path /accounts/{accountId}
     * @allow (get, list) if isSignedIn() && resource.data.adminUserId == request.auth.uid;
     * @allow (create) if isSignedIn() && request.resource.data.adminUserId == request.auth.uid && request.resource.data.id == accountId;
     * @allow (update, delete) if isSignedIn() && isExistingOwner(accountId);
     * @deny (get, list) if true; // Prevent listing all accounts
     * @principle Enforces account ownership for management.
     */
    match /accounts/{accountId} {
      function isOwner() {
        return request.auth != null && resource.data.adminUserId == request.auth.uid;
      }
      function isExistingOwner() {
        return request.auth != null && resource.data.adminUserId == request.auth.uid && resource != null;
      }
      function isSignedIn() {
        return request.auth != null;
      }
       function isAccountAdmin(accountId) {
          return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)).data.adminUserId == request.auth.uid;
       }
       function isExistingAccountAdmin(accountId) {
            return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)).data.adminUserId == request.auth.uid && resource != null;
       }
       function isAccountMember(accountId) {
         return request.auth != null && exists(/databases/$(database)/documents/accounts/$(accountId)/users/$(request.auth.uid));
       }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.adminUserId == request.auth.uid && request.resource.data.id == accountId;
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();

      /**
       * @description Allows account administrators to manage users within their account.
       * @path /accounts/{accountId}/users/{userId}
       * @allow (get, list) if isSignedIn() && isAccountAdmin(accountId);
       * @allow (create) if isSignedIn() && isAccountAdmin(accountId) && request.resource.data.accountId == accountId && request.resource.data.id == userId;
       * @allow (update, delete) if isSignedIn() && isAccountAdmin(accountId) && resource.data.accountId == accountId;
       * @deny (create) if request.resource.data.accountId != accountId;
       * @principle Enforces account-level access control for users.
       */
      match /users/{userId} {
        allow get: if isSignedIn() && isAccountAdmin(accountId);
        allow list: if isSignedIn() && isAccountAdmin(accountId);
        allow create: if isSignedIn() && isAccountAdmin(accountId) && request.resource.data.accountId == accountId && request.resource.data.id == userId;
        allow update: if isSignedIn() && isAccountAdmin(accountId) && resource.data.accountId == accountId;
        allow delete: if isSignedIn() && isExistingAccountAdmin(accountId) && resource.data.accountId == accountId;
      }

      /**
       * @description Allows account members to manage patrons within their account.
       * @path /accounts/{accountId}/patrons/{patronId}
       * @principle Enforces account-level access control for patrons.
       */
      match /patrons/{patronId} {
        allow read, write: if isSignedIn() && (isAccountMember(accountId) || isAccountAdmin(accountId));
      }
      
      /**
      * @description Allows account administrators to manage invitations, and invited users to read them.
      * @path /accounts/{accountId}/invitations/{invitationId}
      * @principle Only account admins can manage invitations, but invited users can read their own.
      */
      match /invitations/{invitationId} {
        allow read: if isSignedIn() && (isAccountAdmin(accountId) || request.auth.token.email == resource.data.email);
        allow write: if isSignedIn() && isAccountAdmin(accountId);
      }

      /**
       * @description Allows account members to manage auctions.
       * @path /accounts/{accountId}/auctions/{auctionId}
       * @principle Enforces account-level and auction-level access control for auctions.
       */
      match /auctions/{auctionId} {
        function isAuctionManager() {
          return request.auth != null && resource.data.managers[request.auth.uid] != null;
        }
        function isExistingAuctionManager() {
            return request.auth != null && resource.data.managers[request.auth.uid] != null && resource != null;
        }

        allow read: if isSignedIn() && (isAccountMember(accountId) || isAccountAdmin(accountId));
        allow create: if isSignedIn() && (
            (request.resource.data.adminUserId == request.auth.uid) || isAccountMember(accountId)
          ) && request.resource.data.accountId == accountId;
        allow update: if isSignedIn() && (isAccountAdmin(accountId) || isAuctionManager()) && resource.data.accountId == accountId;
        allow delete: if isSignedIn() && (isExistingAccountAdmin(accountId) || isExistingAuctionManager()) && resource.data.accountId == accountId;

        /**
         * @description Allows account administrators and auction managers to manage items within an auction.
         * @path /accounts/{accountId}/auctions/{auctionId}/items/{itemId}
         * @principle Enforces account-level and auction-level access control for items.
         */
        match /items/{itemId} {
          function isAuctionManager(accountId, auctionId) {
            return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)/auctions/$(auctionId)).data.managers[request.auth.uid] != null;
          }
          function isExistingAuctionManager(accountId, auctionId) {
            return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)/auctions/$(auctionId)).data.managers[request.auth.uid] != null && resource != null;
          }

          allow read, write: if isSignedIn() && (isAccountAdmin(accountId) || isAuctionManager(accountId, auctionId));
        }

        /**
         * @description Allows account administrators and auction managers to manage lots within an auction.
         * @path /accounts/{accountId}/auctions/{auctionId}/lots/{lotId}
         * @principle Enforces account-level and auction-level access control for lots.
         */
        match /lots/{lotId} {
           function isAuctionManager(accountId, auctionId) {
            return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)/auctions/$(auctionId)).data.managers[request.auth.uid] != null;
          }
           allow read, write: if isSignedIn() && (isAccountAdmin(accountId) || isAuctionManager(accountId, auctionId));
        }

        /**
         * @description Allows account administrators and auction managers to manage categories within an auction.
         * @path /accounts/{accountId}/auctions/{auctionId}/categories/{categoryId}
         * @principle Enforces account-level and auction-level access control for categories.
         */
        match /categories/{categoryId} {
          function isAuctionManager(accountId, auctionId) {
            return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)/auctions/$(auctionId)).data.managers[request.auth.uid] != null;
          }
          function isExistingAuctionManager(accountId, auctionId) {
            return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)/auctions/$(auctionId)).data.managers[request.auth.uid] != null && resource != null;
          }

          allow read, write: if isSignedIn() && (isAccountAdmin(accountId) || isAuctionManager(accountId, auctionId));
        }

        /**
         * @description Allows account administrators and auction managers to manage registered patrons within an auction.
         * @path /accounts/{accountId}/auctions/{auctionId}/registered_patrons/{registeredPatronId}
         * @principle Enforces account-level and auction-level access control for registered patrons.
         */
        match /registered_patrons/{registeredPatronId} {
          function isAuctionManager(accountId, auctionId) {
            return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)/auctions/$(auctionId)).data.managers[request.auth.uid] != null;
          }
          function isExistingAuctionManager(accountId, auctionId) {
            return request.auth != null && get(/databases/$(database)/documents/accounts/$(accountId)/auctions/$(auctionId)).data.managers[request.auth.uid] != null && resource != null;
          }

          allow read, write: if isSignedIn() && (isAccountAdmin(accountId) || isAuctionManager(accountId, auctionId));
        }
      }
    }
  }
}

    